<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat28 - Login/Register</title>
  <link rel="stylesheet" href="stylesheets/login.css">
</head>

<body>
  <div class="login-box" id="loginForm">
    <div class="login-title">Log In to Chat28</div>
    <form onsubmit="handleLogin(event)">
      <div class="login-inner">
        <div class="login-text">Username</div>
        <div class="input-box">
          <input type="text" id="loginUsername" placeholder="Enter your username" required>
        </div>
      </div>
      <div class="login-inner">
        <div class="login-text">Password</div>
        <div class="input-box">
          <input type="password" id="loginPassword" placeholder="Enter your password" required>
        </div>
      </div>
      <button type="submit" class="login-button">Login</button>
      <div id="loginError" style="color: red; margin-top: 10px; font-size: 14px;"></div>
      <div id="loginWarning" style="color: orange; margin-top: 10px; font-size: 14px;"></div>
    </form>

    <div class="flex-row">
      <div class="divider"></div>
      <div class="or-text">OR</div>
      <div class="divider"></div>
    </div>

    <div class="not-member">
      <div>Don't have an account?</div>
      <div onclick="toggleSignUp()" class="sign-up-today">Create an account</div>
    </div>
  </div>

  <div class="login-box" id="signupForm" style="display: none;">
    <div class="login-title">Sign Up for Chat28</div>
    <form onsubmit="handleSignup(event)">
      <div class="login-inner">
        <div class="login-text">Username</div>
        <div class="input-box">
          <input type="text" id="signupUsername" placeholder="Choose a username" required minlength="3">
        </div>
      </div>
      <div class="login-inner">
        <div class="login-text">Password</div>
        <div class="input-box">
          <input type="password" id="signupPassword" placeholder="Create a password" required minlength="6">
        </div>
      </div>
      <div class="login-inner">
        <div class="login-text">Confirm Password</div>
        <div class="input-box">
          <input type="password" id="confirmPassword" placeholder="Confirm password" required>
        </div>
      </div>
      <button type="submit" class="login-button">Sign Up</button>
      <div id="registerError" style="color: red; margin-top: 10px; font-size: 14px;"></div>
      <div id="registerSuccess" style="color: green; margin-top: 10px; font-size: 14px;"></div>
    </form>

    <div class="not-member">
      <div>Already have an account?</div>
      <div onclick="toggleSignUp()" class="sign-up-today">Log in</div>
    </div>
  </div>

  <div id="loadingSpinner" style="display: none; text-align: center; margin-top: 20px;">
    <div
      style="border: 4px solid #f3f3f3; border-top: 4px solid #5f9fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;">
    </div>
    <p>Generating RSA-4096 keys... This may take a moment.</p>
  </div>

  <style>
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>

  <script>
    const API_URL = window.location.origin;
    let isSignUp = false;

    function toggleSignUp() {
      isSignUp = !isSignUp;
      document.getElementById('loginForm').style.display = isSignUp ? 'none' : 'block';
      document.getElementById('signupForm').style.display = isSignUp ? 'block' : 'none';
      document.querySelectorAll('[id$="Error"], [id$="Success"], [id$="Warning"]').forEach(el => el.textContent = '');
    }

    // async function handleSignup(event) {
    //   event.preventDefault();

    //   const username = document.getElementById('signupUsername').value.trim();
    //   const password = document.getElementById('signupPassword').value;
    //   const confirmPassword = document.getElementById('confirmPassword').value;
    //   const errorEl = document.getElementById('registerError');
    //   const successEl = document.getElementById('registerSuccess');
    //   const spinner = document.getElementById('loadingSpinner');

    //   errorEl.textContent = '';
    //   successEl.textContent = '';

    //   if (password !== confirmPassword) {
    //     errorEl.textContent = 'Passwords do not match';
    //     return;
    //   }

    //   try {
    //     spinner.style.display = 'block';
    //     document.getElementById('signupForm').style.display = 'none';

    //     const response = await fetch(`${API_URL}/api/auth/register`, {
    //       method: 'POST',
    //       headers: { 'Content-Type': 'application/json' },
    //       body: JSON.stringify({ username, password })
    //     });

    //     const data = await response.json();

    //     spinner.style.display = 'none';
    //     document.getElementById('signupForm').style.display = 'block';

    //     if (!response.ok) {
    //       throw new Error(data.error || 'Registration failed');
    //     }

    //     // Store per-user
    //     localStorage.setItem(`token_${data.username}`, data.token);
    //     localStorage.setItem(`publicKey_${data.username}`, data.publicKey);
    //     localStorage.setItem(`fingerprint_${data.username}`, data.fingerprint);
    //     localStorage.setItem(`privateKey_${data.username}`, data.privateKey);

    //     // Track active user for convenience (optional)
    //     localStorage.setItem('activeUser', data.username);

    //     // Redirect with explicit user in the URL (tab-isolated)
    //     window.location.href = `/chat.html?u=${encodeURIComponent(data.username)}`;


    //   } catch (error) {
    //     spinner.style.display = 'none';
    //     document.getElementById('signupForm').style.display = 'block';
    //     errorEl.textContent = error.message;
    //   }
    // }

    // async function handleLogin(event) {
    //   event.preventDefault();

    //   const username = document.getElementById('loginUsername').value.trim();
    //   const password = document.getElementById('loginPassword').value;
    //   const errorEl = document.getElementById('loginError');
    //   const warningEl = document.getElementById('loginWarning');

    //   errorEl.textContent = '';
    //   warningEl.textContent = '';

    //   try {
    //     const response = await fetch(`${API_URL}/api/auth/login`, {
    //       method: 'POST',
    //       headers: { 'Content-Type': 'application/json' },
    //       body: JSON.stringify({ username, password })
    //     });

    //     const data = await response.json();

    //     if (!response.ok) {
    //       throw new Error(data.error || 'Login failed');
    //     }

    //     localStorage.setItem(`token_${data.username}`, data.token);
    //     localStorage.setItem(`publicKey_${data.username}`, data.publicKey);
    //     localStorage.setItem(`fingerprint_${data.username}`, data.fingerprint);
    //     localStorage.setItem('activeUser', data.username);

    //     // If user doesnâ€™t have a private key saved locally, still redirect with the username in the query string:
    //     const nextUrl = `/chat.html?u=${encodeURIComponent(data.username)}`;
    //     if (!localStorage.getItem(`privateKey_${data.username}`)) {
    //       warningEl.textContent = 'Private key not found. You will not be able to decrypt messages.';
    //       setTimeout(() => { window.location.href = nextUrl; }, 1500);
    //     } else {
    //       window.location.href = nextUrl;
    //     }


    //   } catch (error) {
    //     errorEl.textContent = error.message;
    //   }
    // }
    async function handleSignup(event) {
      event.preventDefault();

      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('registerError');
      const successEl = document.getElementById('registerSuccess');
      const spinner = document.getElementById('loadingSpinner');

      errorEl.textContent = '';
      successEl.textContent = '';

      if (password !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        return;
      }

      try {
        spinner.style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';

        const response = await fetch(`${API_URL}/api/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        spinner.style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';

        if (!response.ok) {
          throw new Error(data.error || 'Registration failed');
        }

        // Store user data with username as key
        localStorage.setItem(`token_${data.username}`, data.token);
        localStorage.setItem(`publicKey_${data.username}`, data.publicKey);
        localStorage.setItem(`fingerprint_${data.username}`, data.fingerprint);
        localStorage.setItem(`privateKey_${data.username}`, data.privateKey);
        localStorage.setItem('activeUser', data.username);

        // Redirect to chat
        window.location.href = `/chat.html?u=${encodeURIComponent(data.username)}`;

      } catch (error) {
        spinner.style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
        errorEl.textContent = error.message;
      }
    }

    async function handleLogin(event) {
      event.preventDefault();

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      const warningEl = document.getElementById('loginWarning');

      errorEl.textContent = '';
      warningEl.textContent = '';

      try {
        const response = await fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Login failed');
        }

        // Store user data
        localStorage.setItem(`token_${data.username}`, data.token);
        localStorage.setItem(`publicKey_${data.username}`, data.publicKey);
        localStorage.setItem(`fingerprint_${data.username}`, data.fingerprint);
        localStorage.setItem('activeUser', data.username);

        // Check if private key exists
        const hasPrivateKey = !!localStorage.getItem(`privateKey_${data.username}`);
        
        if (!hasPrivateKey) {
          warningEl.textContent = 'Private key not found. You will not be able to decrypt messages.';
          setTimeout(() => { 
            window.location.href = `/chat.html?u=${encodeURIComponent(data.username)}`; 
          }, 2000);
        } else {
          window.location.href = `/chat.html?u=${encodeURIComponent(data.username)}`;
        }

      } catch (error) {
        errorEl.textContent = error.message;
      }
    }
  </script>
</body>

</html>